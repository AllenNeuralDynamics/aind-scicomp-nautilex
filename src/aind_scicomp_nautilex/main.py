import os
import requests
import json
from typing import List, Dict


system_prompt="""
Your task is to solve this issue using the aind-data-migration-utils package. You will need to provide a query, a migration_callback, and a set of metadata core files to limit use to. You should return a run.py file (and ONLY the contents of the run.py, no extra context) which will solve the issue. Your run.py file should look something like this example file:

from aind_data_migration_utils.migrate import Migrator
import pandas as pd
import boto3
import json
import argparse
import logging

s3 = boto3.client('s3')
mangled_data = pd.read_csv('results_mangled.csv')


def repair_processing(record: dict) -> dict:
    \"\"\" Pull the record's original processing data from the original data source\"\"\"

    location = record['location']

    # location looks like s3://codeocean-s3datasetsbucket-1u41qdg42ur9/d48ec453-4cd6-47b7-8ad0-c08176bb42c1
    # separate the bucket and key prefix
    bucket_name, object_key = location.split('/')[2], '/'.join(location.split('/')[3:])

    # add the processing json
    object_key = object_key + '/processing.json'

    response = s3.get_object(Bucket=bucket_name, Key=object_key)

    # Check that the response succeeded
    if response['ResponseMetadata']['HTTPStatusCode'] != 200:
        raise ValueError(f"Failed to retrieve processing data from {location}")

    # # Read and parse JSON content
    json_content = response['Body'].read().decode('utf-8')  # Read and decode bytes
    processing_data = json.loads(json_content)  # Convert JSON string to dictionary

    logging.info(f"Retrieved processing data from {location} for record {record['_id']}")

    record["processing"] = processing_data

    return record


if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument("--dev", action=argparse.BooleanOptionalAction, required=False, default=False)
    parser.add_argument("--full-run", action=argparse.BooleanOptionalAction, required=False, default=False)
    parser.add_argument("--test", action=argparse.BooleanOptionalAction, required=False, default=False)
    args = parser.parse_args()

    # Split into batches of 100 mangled records
    for i in range(0, len(mangled_data), 150):
        mangled_data_batch = mangled_data[i:i + 150]
        query = {
            "_id": {"$in": mangled_data_batch['record_id'].tolist()}
        }
        migrator = Migrator(
            query=query,
            migration_callback=repair_processing,
            files=["processing"],
            path=f"./{i}_repair_processing",
            prod=not args.dev,
        )

        # Run the dry run
        migrator.run(full_run=False, test_mode=args.test)

        # If requested, run the full run
        if args.full_run:
            migrator.run(full_run=True, test_mode=args.test)

To help you understand how the data is organized I'm going to provide you an example of a record that uses the aind-data-schema package. This is a metadata schema built in pydantic that has a top-level "metadata" file that contains 7 files inside of it, "acquisition", "data_description", "procedures", "processing", "quality_control", "rig", "session", and "subject". Not all records use all these fields, and you should be careful to use the files parameter on the Migrator to only select for files that you actually need to make changes to. Be VERY CAREFUL to modify a real field in the metadata when you create your migration_callback function!

Here's an example of what one record looks like
{"_id":"dce785d0-f552-4c7b-8875-f5948811b07d","acquisition":null,"created":"2024-10-09T03:17:56.687733","data_description":{"describedBy":"https://raw.githubusercontent.com/AllenNeuralDynamics/aind-data-schema/main/src/aind_data_schema/core/data_description.py","schema_version":"1.0.0","license":"CC-BY-4.0","platform":{"name":"Behavior platform","abbreviation":"behavior"},"subject_id":"711042","creation_time":"2024-08-07T12:20:41-07:00","label":null,"name":"behavior_711042_2024-08-07_12-20-41","institution":{"name":"Allen Institute for Neural Dynamics","abbreviation":"AIND","registry":{"name":"Research Organization Registry","abbreviation":"ROR"},"registry_identifier":"04szwah67"},"funding_source":[{"funder":{"name":"Allen Institute","abbreviation":"AI","registry":{"name":"Research Organization Registry","abbreviation":"ROR"},"registry_identifier":"03cpe7c52"},"grant_number":null,"fundee":"Cindy Poo, Jeremiah Cohen"}],"data_level":"raw","group":null,"investigators":[{"name":"Cindy Poo","abbreviation":null,"registry":null,"registry_identifier":null},{"name":"Jeremiah Cohen","abbreviation":null,"registry":null,"registry_identifier":null}],"project_name":"Behavior Platform","restrictions":null,"modality":[{"name":"Behavior","abbreviation":"behavior"},{"name":"Behavior videos","abbreviation":"behavior-videos"},{"name":"Fiber photometry","abbreviation":"fib"}],"related_data":[],"data_summary":null},"describedBy":"https://raw.githubusercontent.com/AllenNeuralDynamics/aind-data-schema/main/src/aind_data_schema/core/metadata.py","external_links":{"Code Ocean":["f31eb215-b833-46c2-b107-7a8e590bf3a2"]},"instrument":null,"last_modified":"2025-02-12T01:20:24.867601Z","location":"s3://aind-private-data-prod-o5171v/behavior_711042_2024-08-07_12-20-41","metadata_status":"Unknown","name":"behavior_711042_2024-08-07_12-20-41","procedures":{"describedBy":"https://raw.githubusercontent.com/AllenNeuralDynamics/aind-data-schema/main/src/aind_data_schema/core/procedures.py","notes":null,"schema_version":"0.13.3","specimen_procedures":[],"subject_id":"711042","subject_procedures":[{"anaesthesia":{"duration":"156.0","duration_unit":"minute","level":"1.5","type":"isoflurane"},"animal_weight_post":"23.8","animal_weight_prior":"21.8","experimenter_full_name":"NSB-6465","iacuc_protocol":"2109","notes":null,"procedure_type":"Surgery","procedures":[{"headframe_material":null,"headframe_part_number":null,"headframe_type":"L-shaped","procedure_type":"Headframe","protocol_id":null,"well_part_number":null,"well_type":"No Well"},{"bregma_to_lambda_distance":null,"bregma_to_lambda_unit":"millimeter","injection_angle":"0.0","injection_angle_unit":"degrees","injection_coordinate_ap":"-5.2","injection_coordinate_depth":["-3.1"],"injection_coordinate_ml":"0.85","injection_coordinate_reference":"Bregma","injection_coordinate_unit":"millimeter","injection_duration":null,"injection_duration_unit":"minute","injection_hemisphere":"Right","injection_materials":[{"addgene_id":null,"material_type":"Virus","name":"pAAV-syn-FLEX-jGCaMP8m-WPRE","tars_identifiers":{"plasmid_tars_alias":null,"prep_date":"2024-04-05","prep_lot_number":"v146246","prep_protocol":null,"prep_type":null,"virus_tars_id":"AiV300169"},"titer":24000000000000,"titer_unit":"gc/mL"}],"injection_volume":["400.0"],"injection_volume_unit":"nanoliter","instrument_id":null,"procedure_type":"Nanoject injection","protocol_id":"dx.doi.org/10.17504/protocols.io.bp2l6nr7kgqe/v4","recovery_time":"15.0","recovery_time_unit":"minute","targeted_structure":null},{"probes":[{"angle":"0.0","angle_unit":"degrees","bregma_to_lambda_distance":null,"bregma_to_lambda_unit":"millimeter","notes":null,"stereotactic_coordinate_ap":"-5.2","stereotactic_coordinate_dv":null,"stereotactic_coordinate_ml":"0.85","stereotactic_coordinate_reference":"Bregma","stereotactic_coordinate_unit":"millimeter","targeted_structure":null}],"procedure_type":"Fiber implant","protocol_id":null},{"bregma_to_lambda_distance":null,"bregma_to_lambda_unit":"millimeter","injection_angle":"0.0","injection_angle_unit":"degrees","injection_coordinate_ap":"-5.2","injection_coordinate_depth":["-3.1"],"injection_coordinate_ml":"-0.85","injection_coordinate_reference":"Bregma","injection_coordinate_unit":"millimeter","injection_duration":null,"injection_duration_unit":"minute","injection_hemisphere":"Left","injection_materials":[{"addgene_id":null,"material_type":"Virus","name":"pAAV-syn-FLEX-jGCaMP8m-WPRE","tars_identifiers":{"plasmid_tars_alias":null,"prep_date":"2024-04-05","prep_lot_number":"v146246","prep_protocol":null,"prep_type":null,"virus_tars_id":"AiV300169"},"titer":24000000000000,"titer_unit":"gc/mL"}],"injection_volume":["400.0"],"injection_volume_unit":"nanoliter","instrument_id":null,"procedure_type":"Nanoject injection","protocol_id":"dx.doi.org/10.17504/protocols.io.bp2l6nr7kgqe/v4","recovery_time":"15.0","recovery_time_unit":"minute","targeted_structure":null},{"probes":[{"angle":"12.0","angle_unit":"degrees","bregma_to_lambda_distance":null,"bregma_to_lambda_unit":"millimeter","notes":null,"stereotactic_coordinate_ap":"-6.2","stereotactic_coordinate_dv":"-4.2","stereotactic_coordinate_ml":"-1.5","stereotactic_coordinate_reference":"Bregma","stereotactic_coordinate_unit":"millimeter","targeted_structure":null}],"procedure_type":"Fiber implant","protocol_id":null},{"probes":[{"angle":"0.0","angle_unit":"degrees","bregma_to_lambda_distance":null,"bregma_to_lambda_unit":"millimeter","notes":null,"stereotactic_coordinate_ap":"-1.6","stereotactic_coordinate_dv":"3.2","stereotactic_coordinate_ml":"-1.6","stereotactic_coordinate_reference":"Bregma","stereotactic_coordinate_unit":"millimeter","targeted_structure":null}],"procedure_type":"Fiber implant","protocol_id":null}],"protocol_id":"dx.doi.org/10.17504/protocols.io.kqdg392o7g25/v2","start_date":"2024-04-15","weight_unit":"gram","workstation_id":"SWS 2"}]},"processing":{"analyses":[],"describedBy":"https://raw.githubusercontent.com/AllenNeuralDynamics/aind-data-schema/main/src/aind_data_schema/core/processing.py","notes":null,"processing_pipeline":{"data_processes":[],"note":null,"pipeline_url":null,"pipeline_version":null,"processor_full_name":"AIND Scientific Computing"},"schema_version":"0.4.8"},"quality_control":{"describedBy":"https://raw.githubusercontent.com/AllenNeuralDynamics/aind-data-schema/main/src/aind_data_schema/core/quality_control.py","schema_version":"1.1.1","evaluations":[{"modality":{"name":"Behavior videos","abbreviation":"behavior-videos"},"stage":"Raw data","name":"Preview Artifacts","description":"Preview Gifs and First Frames","metrics":[{"name":"Preview Video","value":{},"description":null,"reference":"sha1://bd1a05da88072ac4c1fa3464448048db6b30f93c?label=vid_bottom_camera_start_0_end_5.gif","status_history":[{"evaluator":"","status":"Pending","timestamp":"2024-11-23T16:59:55.657Z"}]}],"notes":null,"allow_failed_metrics":false},{"modality":{"name":"Behavior videos","abbreviation":"behavior-videos"},"stage":"Raw data","name":"Preview Artifacts","description":"Preview Gifs and First Frames","metrics":[{"name":"Preview Video","value":{},"status_history":[{"evaluator":"","status":"Pending","timestamp":"2024-11-23T17:00:00.235756Z"}],"description":null,"reference":"sha1://8e47c9e8ba8b734d670fb453a16ef57e17645c4f?label=vid_bottom_camera_start_1577_end_1582.gif","evaluated_assets":null}],"notes":null,"allow_failed_metrics":false},{"modality":{"name":"Behavior videos","abbreviation":"behavior-videos"},"stage":"Raw data","name":"Preview Artifacts","description":"Preview Gifs and First Frames","metrics":[{"name":"Preview Video","value":{},"status_history":[{"evaluator":"","status":"Pending","timestamp":"2024-11-23T17:00:02.461202Z"}],"description":null,"reference":"sha1://00c60302c1aa772d51c96c3a13141b8c0b090a17?label=vid_bottom_camera_start_3155_end_3160.gif","evaluated_assets":null}],"notes":null,"allow_failed_metrics":false},{"modality":{"name":"Behavior videos","abbreviation":"behavior-videos"},"stage":"Raw data","name":"Preview Artifacts","description":"Preview Gifs and First Frames","metrics":[{"name":"Preview Video","value":{},"status_history":[{"evaluator":"","status":"Pending","timestamp":"2024-11-23T17:00:04.121881Z"}],"description":null,"reference":"sha1://8bd21e557ebc1748ecd8566858d48e3683c36b1a?label=vid_side_camera_right_start_0_end_5.gif","evaluated_assets":null}],"notes":null,"allow_failed_metrics":false},{"modality":{"name":"Behavior videos","abbreviation":"behavior-videos"},"stage":"Raw data","name":"Preview Artifacts","description":"Preview Gifs and First Frames","metrics":[{"name":"Preview Video","value":{},"status_history":[{"evaluator":"","status":"Pending","timestamp":"2024-11-23T17:00:05.901226Z"}],"description":null,"reference":"sha1://a6ba74c0dde3a56b4e1b18b9dc9bde0da8dc0d5a?label=vid_side_camera_right_start_1585_end_1590.gif","evaluated_assets":null}],"notes":null,"allow_failed_metrics":false},{"modality":{"name":"Behavior videos","abbreviation":"behavior-videos"},"stage":"Raw data","name":"Preview Artifacts","description":"Preview Gifs and First Frames","metrics":[{"name":"Preview Video","value":{},"status_history":[{"evaluator":"","status":"Pending","timestamp":"2024-11-23T17:00:07.570138Z"}],"description":null,"reference":"sha1://2ae339c1e826c3d492748809d326f299fed5e069?label=vid_side_camera_right_start_3171_end_3176.gif","evaluated_assets":null}],"notes":null,"allow_failed_metrics":false}],"notes":null},"rig":{"additional_devices":[{"additional_settings":{},"device_type":"Photometry Clock","manufacturer":null,"model":null,"name":"Photometry Clock","notes":null,"path_to_cad":null,"port_index":null,"serial_number":null}],"calibrations":[{"calibration_date":"2024-08-05T00:00:00-07:00","description":"Spot check of water calibration for Lick spout Left. The input is the valve open time in seconds and the output is the volume of water delievered in microliters. The valve open time was selected to produce 2ul of water. This measurement was used to check the previous calibration, and was not used to set the calibration.","device_name":"Lick spout Left","input":{"valve open time (s):":[0.0234]},"notes":null,"output":{"water volume (ul):":[2]}},{"calibration_date":"2024-07-31T00:00:00-07:00","description":"Spot check of water calibration for Lick spout Left. The input is the valve open time in seconds and the output is the volume of water delievered in microliters. The valve open time was selected to produce 2ul of water. This measurement was used to check the previous calibration, and was not used to set the calibration.","device_name":"Lick spout Left","input":{"valve open time (s):":[0.0234]},"notes":null,"output":{"water volume (ul):":[2.15]}},{"calibration_date":"2024-07-22T00:00:00-07:00","description":"Spot check of water calibration for Lick spout Left. The input is the valve open time in seconds and the output is the volume of water delievered in microliters. The valve open time was selected to produce 2ul of water. This measurement was used to check the previous calibration, and was not used to set the calibration.","device_name":"Lick spout Left","input":{"valve open time (s):":[0.0234]},"notes":null,"output":{"water volume (ul):":[2.25]}},{"calibration_date":"2024-05-17T00:00:00-07:00","description":"Water calibration for Lick spout Left. The input is the valve open time in seconds and the output is the volume of water delivered in microliters.","device_name":"Lick spout Left","input":{"valve open time (s):":[0.005,0.01,0.015,0.02,0.025,0.03,0.035,0.04,0.045,0.05,0.055,0.06,0.065,0.07]},"notes":null,"output":{"water volume (ul):":[0.6000000000000005,1.0000000000000009,1.299999999999999,1.8000000000000016,2.150000000000003,2.549999999999999,2.9499999999999993,3.3000000000000007,3.5500000000000047,3.899999999999997,4.15,4.500000000000002,4.6999999999999975,5.199999999999996]}},{"calibration_date":"2024-08-05T00:00:00-07:00","description":"Spot check of water calibration for Lick spout Right. The input is the valve open time in seconds and the output is the volume of water delievered in microliters. The valve open time was selected to produce 2ul of water. This measurement was used to check the previous calibration, and was not used to set the calibration.","device_name":"Lick spout Right","input":{"valve open time (s):":[0.0222]},"notes":null,"output":{"water volume (ul):":[2]}},{"calibration_date":"2024-08-01T00:00:00-07:00","description":"Water calibration for Lick spout Right. The input is the valve open time in seconds and the output is the volume of water delivered in microliters.","device_name":"Lick spout Right","input":{"valve open time (s):":[0.02,0.025,0.03,0.035,0.04,0.045,0.05]},"notes":null,"output":{"water volume (ul):":[1.75,2.2,2.65,3.1,3.45,3.8,4.1]}}],"cameras":[{"camera":{"additional_settings":{},"bin_height":null,"bin_mode":"None","bin_unit":"pixel","bin_width":null,"bit_depth":null,"chroma":"Monochrome","computer_name":"W10DT714674","cooling":"Air","crop_height":null,"crop_unit":"pixel","crop_width":null,"data_interface":"USB","detector_type":"Camera","device_type":"Detector","driver":null,"driver_version":null,"frame_rate_unit":"hertz","gain":null,"immersion":null,"manufacturer":{"abbreviation":"FLIR","name":"Teledyne FLIR","registry":{"abbreviation":"ROR","name":"Research Organization Registry"},"registry_identifier":"01j1gwp17"},"max_frame_rate":"522","model":"Blackfly S BFS-U3-04S2M","name":"Right size of face camera","notes":null,"path_to_cad":null,"port_index":null,"recording_software":null,"sensor_format":"1/2.9","sensor_format_unit":"inch","sensor_height":540,"sensor_width":720,"serial_number":"23347799","size_unit":"pixel"},"camera_target":"Face side right","filter":null,"lens":{"additional_settings":{},"device_type":"Lens","focal_length":"16","focal_length_unit":"millimeter","lens_size_unit":"inch","manufacturer":{"abbreviation":null,"name":"Fujinon","registry":null,"registry_identifier":null},"max_aperture":null,"model":"CF16ZA-1S","name":"Behavior Video Lens Right Side","notes":null,"optimized_wavelength_range":null,"path_to_cad":null,"port_index":null,"serial_number":null,"size":null,"wavelength_unit":"nanometer"},"name":"Right Camera assembly","position":null},{"camera":{"additional_settings":{},"bin_height":null,"bin_mode":"None","bin_unit":"pixel","bin_width":null,"bit_depth":null,"chroma":"Monochrome","computer_name":"W10DT714674","cooling":"Air","crop_height":null,"crop_unit":"pixel","crop_width":null,"data_interface":"USB","detector_type":"Camera","device_type":"Detector","driver":null,"driver_version":null,"frame_rate_unit":"hertz","gain":null,"immersion":null,"manufacturer":{"abbreviation":"FLIR","name":"Teledyne FLIR","registry":{"abbreviation":"ROR","name":"Research Organization Registry"},"registry_identifier":"01j1gwp17"},"max_frame_rate":"522","model":"Blackfly S BFS-U3-04S2M","name":"bottom of face camera","notes":null,"path_to_cad":null,"port_index":null,"recording_software":null,"sensor_format":"1/2.9","sensor_format_unit":"inch","sensor_height":540,"sensor_width":720,"serial_number":"23349436","size_unit":"pixel"},"camera_target":"Face bottom","filter":null,"lens":{"additional_settings":{},"device_type":"Lens","focal_length":"25","focal_length_unit":"millimeter","lens_size_unit":"inch","manufacturer":{"abbreviation":null,"name":"Other","registry":null,"registry_identifier":null},"max_aperture":null,"model":"LM25HC","name":"Behavior Video Lens Bottom of face","notes":"Manufacturer is Kowa","optimized_wavelength_range":null,"path_to_cad":null,"port_index":null,"serial_number":null,"size":null,"wavelength_unit":"nanometer"},"name":"Bottom Camera assembly","position":null}],"ccf_coordinate_transform":null,"daqs":[{"additional_settings":{},"channels":[{"channel_index":null,"channel_name":"DI3","channel_type":"Digital Input","device_name":"Photometry Clock","event_based_sampling":null,"port":null,"sample_rate":null,"sample_rate_unit":"hertz"}],"computer_name":"W10DT714674","core_version":"1.11","data_interface":"Ethernet","device_type":"Harp device","firmware_version":null,"hardware_version":null,"harp_device_type":{"name":"Behavior","whoami":1216},"is_clock_generator":false,"manufacturer":{"abbreviation":null,"name":"Champalimaud Foundation","registry":{"abbreviation":"ROR","name":"Research Organization Registry"},"registry_identifier":"03g001n57"},"model":null,"name":"Harp Behavior","notes":"Left lick spout and Right lick spout, as well as reward delivery solenoids are connected via ethernet cables","path_to_cad":null,"port_index":null,"serial_number":null,"tag_version":null},{"additional_settings":{},"channels":[],"computer_name":"W10DT714674","core_version":"1.4","data_interface":"USB","device_type":"Harp device","firmware_version":null,"hardware_version":null,"harp_device_type":{"name":"Sound Card","whoami":1280},"is_clock_generator":false,"manufacturer":{"abbreviation":null,"name":"Champalimaud Foundation","registry":{"abbreviation":"ROR","name":"Research Organization Registry"},"registry_identifier":"03g001n57"},"model":null,"name":"Harp Sound","notes":null,"path_to_cad":null,"port_index":null,"serial_number":null,"tag_version":null},{"additional_settings":{},"channels":[],"computer_name":"W10DT714674","core_version":"","data_interface":"USB","device_type":"Harp device","firmware_version":null,"hardware_version":null,"harp_device_type":{"name":"Clock Synchronizer","whoami":1152},"is_clock_generator":true,"manufacturer":{"abbreviation":null,"name":"Champalimaud Foundation","registry":{"abbreviation":"ROR","name":"Research Organization Registry"},"registry_identifier":"03g001n57"},"model":null,"name":"Harp clock synchronization board","notes":null,"path_to_cad":null,"port_index":null,"serial_number":null,"tag_version":null},{"additional_settings":{},"channels":[],"computer_name":"W10DT714674","core_version":"","data_interface":"USB","device_type":"Harp device","firmware_version":null,"hardware_version":null,"harp_device_type":{"name":"Input Expander","whoami":1106},"is_clock_generator":false,"manufacturer":{"abbreviation":null,"name":"Champalimaud Foundation","registry":{"abbreviation":"ROR","name":"Research Organization Registry"},"registry_identifier":"03g001n57"},"model":null,"name":"Harp sound amplifier","notes":null,"path_to_cad":null,"port_index":null,"serial_number":null,"tag_version":null}],"describedBy":"https://raw.githubusercontent.com/AllenNeuralDynamics/aind-data-schema/main/src/aind_data_schema/core/rig.py","detectors":[{"additional_settings":{},"bin_height":4,"bin_mode":"Additive","bin_unit":"pixel","bin_width":4,"bit_depth":16,"chroma":"Monochrome","computer_name":null,"cooling":"Air","crop_height":200,"crop_unit":"pixel","crop_width":200,"data_interface":"USB","detector_type":"Camera","device_type":"Detector","driver":null,"driver_version":null,"frame_rate_unit":"hertz","gain":"2","immersion":"air","manufacturer":{"abbreviation":"FLIR","name":"Teledyne FLIR","registry":{"abbreviation":"ROR","name":"Research Organization Registry"},"registry_identifier":"01j1gwp17"},"max_frame_rate":null,"model":"BFS-U3-20S40M","name":"Green CMOS","notes":null,"path_to_cad":null,"port_index":null,"recording_software":null,"sensor_format":null,"sensor_format_unit":null,"sensor_height":null,"sensor_width":null,"serial_number":"23321567","size_unit":"pixel"},{"additional_settings":{},"bin_height":4,"bin_mode":"Additive","bin_unit":"pixel","bin_width":4,"bit_depth":16,"chroma":"Monochrome","computer_name":null,"cooling":"Air","crop_height":200,"crop_unit":"pixel","crop_width":200,"data_interface":"USB","detector_type":"Camera","device_type":"Detector","driver":null,"driver_version":null,"frame_rate_unit":"hertz","gain":"2","immersion":"air","manufacturer":{"abbreviation":"FLIR","name":"Teledyne FLIR","registry":{"abbreviation":"ROR","name":"Research Organization Registry"},"registry_identifier":"01j1gwp17"},"max_frame_rate":null,"model":"BFS-U3-20S40M","name":"Red CMOS","notes":null,"path_to_cad":null,"port_index":null,"recording_software":null,"sensor_format":null,"sensor_format_unit":null,"sensor_height":null,"sensor_width":null,"serial_number":"23321566","size_unit":"pixel"}],"digital_micromirror_devices":[],"enclosure":{"additional_settings":{},"air_filtration":false,"device_type":"Enclosure","external_material":"","grounded":false,"internal_material":"","laser_interlock":false,"manufacturer":{"abbreviation":"AIND","name":"Allen Institute for Neural Dynamics","registry":{"abbreviation":"ROR","name":"Research Organization Registry"},"registry_identifier":"04szwah67"},"model":null,"name":"Behavior enclosure","notes":null,"path_to_cad":null,"port_index":null,"serial_number":null,"size":{"height":54,"length":54,"unit":"centimeter","width":54}},"ephys_assemblies":[],"fiber_assemblies":[],"filters":[{"additional_settings":{},"center_wavelength":520,"cut_off_wavelength":null,"cut_on_wavelength":null,"description":null,"device_type":"Filter","diameter":"25","filter_type":"Band pass","filter_wheel_index":null,"height":null,"manufacturer":{"abbreviation":null,"name":"Semrock","registry":null,"registry_identifier":null},"model":"FF01-520/35-25","name":"Green emission filter","notes":null,"path_to_cad":null,"port_index":null,"serial_number":null,"size_unit":"millimeter","thickness":null,"thickness_unit":"millimeter","wavelength_unit":"nanometer","width":null},{"additional_settings":{},"center_wavelength":600,"cut_off_wavelength":null,"cut_on_wavelength":null,"description":null,"device_type":"Filter","diameter":"25","filter_type":"Band pass","filter_wheel_index":null,"height":null,"manufacturer":{"abbreviation":null,"name":"Semrock","registry":null,"registry_identifier":null},"model":"FF01-600/37-25","name":"Red emission filter","notes":null,"path_to_cad":null,"port_index":null,"serial_number":null,"size_unit":"millimeter","thickness":null,"thickness_unit":"millimeter","wavelength_unit":"nanometer","width":null},{"additional_settings":{},"center_wavelength":null,"cut_off_wavelength":562,"cut_on_wavelength":null,"description":null,"device_type":"Filter","diameter":null,"filter_type":"Dichroic","filter_wheel_index":null,"height":"25","manufacturer":{"abbreviation":null,"name":"Semrock","registry":null,"registry_identifier":null},"model":"FF562-Di03-25x36","name":"Emission Dichroic","notes":null,"path_to_cad":null,"port_index":null,"serial_number":null,"size_unit":"millimeter","thickness":null,"thickness_unit":"millimeter","wavelength_unit":"nanometer","width":"36"},{"additional_settings":{},"center_wavelength":null,"cut_off_wavelength":null,"cut_on_wavelength":null,"description":null,"device_type":"Filter","diameter":null,"filter_type":"Multiband","filter_wheel_index":null,"height":"25","manufacturer":{"abbreviation":null,"name":"Semrock","registry":null,"registry_identifier":null},"model":"FF493/574-Di01-25x36","name":"beamsplitter","notes":"493/574 nm BrightLine dual-edge standard epi-fluorescence dichroic beamsplitter","path_to_cad":null,"port_index":null,"serial_number":null,"size_unit":"millimeter","thickness":null,"thickness_unit":"millimeter","wavelength_unit":"nanometer","width":"36"},{"additional_settings":{},"center_wavelength":410,"cut_off_wavelength":null,"cut_on_wavelength":null,"description":null,"device_type":"Filter","diameter":"25","filter_type":"Band pass","filter_wheel_index":null,"height":null,"manufacturer":{"abbreviation":null,"name":"Thorlabs","registry":{"abbreviation":"ROR","name":"Research Organization Registry"},"registry_identifier":"04gsnvb07"},"model":"FB410-10","name":"Excitation filter 410nm","notes":null,"path_to_cad":null,"port_index":null,"serial_number":null,"size_unit":"millimeter","thickness":null,"thickness_unit":"millimeter","wavelength_unit":"nanometer","width":null},{"additional_settings":{},"center_wavelength":470,"cut_off_wavelength":null,"cut_on_wavelength":null,"description":null,"device_type":"Filter","diameter":"25","filter_type":"Band pass","filter_wheel_index":null,"height":null,"manufacturer":{"abbreviation":null,"name":"Thorlabs","registry":{"abbreviation":"ROR","name":"Research Organization Registry"},"registry_identifier":"04gsnvb07"},"model":"FB470-10","name":"Excitation filter 470nm","notes":null,"path_to_cad":null,"port_index":null,"serial_number":null,"size_unit":"millimeter","thickness":null,"thickness_unit":"millimeter","wavelength_unit":"nanometer","width":null},{"additional_settings":{},"center_wavelength":560,"cut_off_wavelength":null,"cut_on_wavelength":null,"description":null,"device_type":"Filter","diameter":"25","filter_type":"Band pass","filter_wheel_index":null,"height":null,"manufacturer":{"abbreviation":null,"name":"Thorlabs","registry":{"abbreviation":"ROR","name":"Research Organization Registry"},"registry_identifier":"04gsnvb07"},"model":"FB560-10","name":"Excitation filter 560nm","notes":null,"path_to_cad":null,"port_index":null,"serial_number":null,"size_unit":"millimeter","thickness":null,"thickness_unit":"millimeter","wavelength_unit":"nanometer","width":null},{"additional_settings":{},"center_wavelength":null,"cut_off_wavelength":450,"cut_on_wavelength":null,"description":null,"device_type":"Filter","diameter":null,"filter_type":"Dichroic","filter_wheel_index":null,"height":"25.2","manufacturer":{"abbreviation":null,"name":"Edmund Optics","registry":{"abbreviation":"ROR","name":"Research Organization Registry"},"registry_identifier":"01j1gwp17"},"model":"#69-898","name":"450 Dichroic Longpass Filter","notes":null,"path_to_cad":null,"port_index":null,"serial_number":null,"size_unit":"millimeter","thickness":null,"thickness_unit":"millimeter","wavelength_unit":"nanometer","width":"35.6"},{"additional_settings":{},"center_wavelength":null,"cut_off_wavelength":500,"cut_on_wavelength":null,"description":null,"device_type":"Filter","diameter":null,"filter_type":"Dichroic","filter_wheel_index":null,"height":"23.2","manufacturer":{"abbreviation":null,"name":"Edmund Optics","registry":{"abbreviation":"ROR","name":"Research Organization Registry"},"registry_identifier":"01j1gwp17"},"model":"#69-899","name":"500 Dichroic Longpass Filter","notes":null,"path_to_cad":null,"port_index":null,"serial_number":null,"size_unit":"millimeter","thickness":null,"thickness_unit":"millimeter","wavelength_unit":"nanometer","width":"35.6"}],"laser_assemblies":[],"lenses":[{"additional_settings":{},"device_type":"Lens","focal_length":"80","focal_length_unit":"millimeter","lens_size_unit":"inch","manufacturer":{"abbreviation":null,"name":"Thorlabs","registry":{"abbreviation":"ROR","name":"Research Organization Registry"},"registry_identifier":"04gsnvb07"},"max_aperture":null,"model":"AC254-080-A-ML","name":"Image focusing lens","notes":null,"optimized_wavelength_range":null,"path_to_cad":null,"port_index":null,"serial_number":null,"size":1,"wavelength_unit":"nanometer"}],"light_sources":[{"additional_settings":{},"device_type":"Light emitting diode","manufacturer":{"abbreviation":null,"name":"Thorlabs","registry":{"abbreviation":"ROR","name":"Research Organization Registry"},"registry_identifier":"04gsnvb07"},"model":"M810L5","name":"IR LED","notes":null,"path_to_cad":null,"port_index":null,"serial_number":null,"wavelength":810,"wavelength_unit":"nanometer"},{"additional_settings":{},"device_type":"Light emitting diode","manufacturer":{"abbreviation":null,"name":"Thorlabs","registry":{"abbreviation":"ROR","name":"Research Organization Registry"},"registry_identifier":"04gsnvb07"},"model":"M470F3","name":"470nm LED","notes":null,"path_to_cad":null,"port_index":null,"serial_number":null,"wavelength":470,"wavelength_unit":"nanometer"},{"additional_settings":{},"device_type":"Light emitting diode","manufacturer":{"abbreviation":null,"name":"Thorlabs","registry":{"abbreviation":"ROR","name":"Research Organization Registry"},"registry_identifier":"04gsnvb07"},"model":"M415F3","name":"415nm LED","notes":null,"path_to_cad":null,"port_index":null,"serial_number":null,"wavelength":415,"wavelength_unit":"nanometer"},{"additional_settings":{},"device_type":"Light emitting diode","manufacturer":{"abbreviation":null,"name":"Thorlabs","registry":{"abbreviation":"ROR","name":"Research Organization Registry"},"registry_identifier":"04gsnvb07"},"model":"M565F3","name":"565nm LED","notes":null,"path_to_cad":null,"port_index":null,"serial_number":null,"wavelength":565,"wavelength_unit":"nanometer"}],"modalities":[{"abbreviation":"behavior","name":"Behavior"},{"abbreviation":"fib","name":"Fiber photometry"},{"abbreviation":"behavior-videos","name":"Behavior videos"}],"modification_date":"2024-08-05","mouse_platform":{"additional_settings":{},"date_surface_replaced":null,"device_type":"Tube","diameter":"3.0","diameter_unit":"centimeter","manufacturer":{"abbreviation":null,"name":"Custom","registry":null,"registry_identifier":null},"model":null,"name":"mouse_tube_foraging","notes":null,"path_to_cad":null,"port_index":null,"serial_number":null,"surface_material":null},"notes":null,"objectives":[{"additional_settings":{},"device_type":"Objective","immersion":"air","magnification":"10","manufacturer":{"abbreviation":null,"name":"Nikon","registry":{"abbreviation":"ROR","name":"Research Organization Registry"},"registry_identifier":"0280y9h11"},"model":"CFI Plan Apochromat Lambda D 10x","name":"Objective","notes":null,"numerical_aperture":"0.45","objective_type":null,"path_to_cad":null,"port_index":null,"serial_number":"128122198"}],"origin":null,"patch_cords":[{"additional_settings":{},"core_diameter":"200","device_type":"Patch","manufacturer":{"abbreviation":null,"name":"Doric","registry":{"abbreviation":"ROR","name":"Research Organization Registry"},"registry_identifier":"059n53q30"},"model":"BBP(4)_200/220/900-0.37_Custom_FCM-4xMF1.25","name":"Bundle Branching Fiber-optic Patch Cord","notes":null,"numerical_aperture":"0.37","path_to_cad":null,"photobleaching_date":null,"port_index":null,"serial_number":null}],"pockels_cells":[],"polygonal_scanners":[],"rig_axes":null,"rig_id":"446-6-D_20240805","schema_version":"0.3.8","stick_microscopes":[],"stimulus_devices":[{"device_type":"Reward delivery","reward_spouts":[{"additional_settings":{},"device_type":"Reward spout","lick_sensor":{"additional_settings":{},"device_type":"Lick Sensor","manufacturer":{"abbreviation":"Janelia","name":"Janelia Research Campus","registry":{"abbreviation":"ROR","name":"Research Organization Registry"},"registry_identifier":"013sk6x84"},"model":null,"name":"Lick Sensor Left","notes":null,"path_to_cad":null,"port_index":null,"serial_number":null},"lick_sensor_type":"Capacitive","manufacturer":null,"model":null,"name":"Left lick spout","notes":null,"path_to_cad":null,"port_index":null,"serial_number":null,"side":"Left","solenoid_valve":{"additional_settings":{},"device_type":"Solenoid","manufacturer":{"abbreviation":null,"name":"The Lee Company","registry":null,"registry_identifier":null},"model":"LHDA1233415H","name":"Solenoid Left","notes":null,"path_to_cad":null,"port_index":null,"serial_number":null},"spout_diameter":"1.2","spout_diameter_unit":"millimeter","spout_position":null},{"additional_settings":{},"device_type":"Reward spout","lick_sensor":{"additional_settings":{},"device_type":"Lick Sensor","manufacturer":{"abbreviation":"Janelia","name":"Janelia Research Campus","registry":{"abbreviation":"ROR","name":"Research Organization Registry"},"registry_identifier":"013sk6x84"},"model":null,"name":"Lick Sensor Right","notes":null,"path_to_cad":null,"port_index":null,"serial_number":null},"lick_sensor_type":"Capacitive","manufacturer":null,"model":null,"name":"Right lick spout","notes":null,"path_to_cad":null,"port_index":null,"serial_number":null,"side":"Right","solenoid_valve":{"additional_settings":{},"device_type":"Solenoid","manufacturer":{"abbreviation":null,"name":"The Lee Company","registry":null,"registry_identifier":null},"model":"LHDA1233415H","name":"Solenoid Right","notes":null,"path_to_cad":null,"port_index":null,"serial_number":null},"spout_diameter":"1.2","spout_diameter_unit":"millimeter","spout_position":null}],"stage_type":{"additional_settings":{},"device_type":"Motorized stage","firmware":null,"manufacturer":{"abbreviation":"AIND","name":"Allen Institute for Neural Dynamics","registry":{"abbreviation":"ROR","name":"Research Organization Registry"},"registry_identifier":"04szwah67"},"model":null,"name":"AIND lick spout stage","notes":"https://allenneuraldynamics.github.io/Bonsai.AllenNeuralDynamics/articles/aind-manipulator.html","path_to_cad":null,"port_index":null,"serial_number":null,"travel":"30","travel_unit":"millimeter"}},{"additional_settings":{},"device_type":"Speaker","manufacturer":{"abbreviation":null,"name":"Tymphany","registry":null,"registry_identifier":null},"model":"XT25SC90-04","name":"Stimulus Speaker","notes":null,"path_to_cad":null,"port_index":null,"position":null,"serial_number":null}]},"schema_version":"1.0.0","session":{"active_mouse_platform":false,"anaesthesia":null,"animal_weight_post":"21.2","animal_weight_prior":null,"calibrations":[],"data_streams":[{"camera_names":[],"daq_names":["Harp Behavior","Harp Sound","Harp clock synchronization board","Harp sound amplifier","Lick Sensor Left","Lick Sensor Right"],"detectors":[],"ephys_modules":[],"fiber_connections":[],"fiber_modules":[],"light_sources":[],"manipulator_modules":[],"mri_scans":[],"notes":null,"ophys_fovs":[],"slap_fovs":null,"software":[{"name":"dynamic-foraging-task","parameters":{},"url":"https://github.com/AllenNeuralDynamics/dynamic-foraging-task.git","version":"behavior branch:main   commit ID:5428e6749f7193c4b2ea109d1d11e54d75edbfdc    version:1.4.1; metadata branch: main   commit ID:5428e6749f7193c4b2ea109d1d11e54d75edbfdc   version:1.4.1"}],"stack_parameters":null,"stick_microscopes":[],"stream_end_time":"2024-08-07T13:46:16.146082-07:00","stream_modalities":[{"abbreviation":"behavior","name":"Behavior"}],"stream_start_time":"2024-08-07T12:21:07.951292-07:00"},{"camera_names":[],"daq_names":[""],"detectors":[{"exposure_time":"5125.008904","exposure_time_unit":"millisecond","name":"Green CMOS","trigger_type":"Internal"},{"exposure_time":"5125.008904","exposure_time_unit":"millisecond","name":"Red CMOS","trigger_type":"Internal"}],"ephys_modules":[],"fiber_connections":[{"fiber_name":"Fiber 0","output_power_unit":"microwatt","patch_cord_name":"Patch Cord A","patch_cord_output_power":"20"},{"fiber_name":"Fiber 1","output_power_unit":"microwatt","patch_cord_name":"Patch Cord B","patch_cord_output_power":"20"},{"fiber_name":"Fiber 2","output_power_unit":"microwatt","patch_cord_name":"Patch Cord C","patch_cord_output_power":"20"},{"fiber_name":"Fiber 3","output_power_unit":"microwatt","patch_cord_name":"Patch Cord D","patch_cord_output_power":"20"}],"fiber_modules":[],"light_sources":[{"device_type":"LightEmittingDiode","excitation_power":null,"excitation_power_unit":"milliwatt","name":"IR LED"},{"device_type":"LightEmittingDiode","excitation_power":null,"excitation_power_unit":"milliwatt","name":"470nm LED"},{"device_type":"LightEmittingDiode","excitation_power":null,"excitation_power_unit":"milliwatt","name":"415nm LED"},{"device_type":"LightEmittingDiode","excitation_power":null,"excitation_power_unit":"milliwatt","name":"565nm LED"}],"manipulator_modules":[],"mri_scans":[],"notes":"fib mode: Axon","ophys_fovs":[],"slap_fovs":null,"software":[],"stack_parameters":null,"stick_microscopes":[],"stream_end_time":"2024-08-07T13:46:32.960196-07:00","stream_modalities":[{"abbreviation":"fib","name":"Fiber photometry"}],"stream_start_time":"2024-08-07T12:21:07.951292-07:00"},{"camera_names":["Face side right","Bottom"],"daq_names":[],"detectors":[],"ephys_modules":[],"fiber_connections":[],"fiber_modules":[],"light_sources":[],"manipulator_modules":[],"mri_scans":[],"notes":null,"ophys_fovs":[],"slap_fovs":null,"software":[],"stack_parameters":null,"stick_microscopes":[],"stream_end_time":"2024-08-07T13:49:28.342495-07:00","stream_modalities":[{"abbreviation":"behavior-videos","name":"Behavior videos"}],"stream_start_time":"2024-08-07T12:18:59.400471-07:00"}],"describedBy":"https://raw.githubusercontent.com/AllenNeuralDynamics/aind-data-schema/main/src/aind_data_schema/core/session.py","experimenter_full_name":["Avalon Amayal"],"iacuc_protocol":"2109","maintenance":[],"mouse_platform_name":"mouse_tube_foraging","notes":"ended session at 85 min","protocol_id":[""],"reward_consumed_total":"507.0","reward_consumed_unit":"microliter","reward_delivery":null,"rig_id":"446-6-D_20240805","schema_version":"0.2.6","session_end_time":"2024-08-07T13:46:16.146082-07:00","session_start_time":"2024-08-07T12:21:07.951292-07:00","session_type":"Coupled Without Baiting","stimulus_epochs":[{"light_source_config":null,"notes":"The duration of go cue is 100ms. The frequency is 7500Hz. Decibel is 74dB. The total reward consumed in the session is 507.0 microliter. The total reward indcluding consumed in the session and supplementary water is 1.0 millimeters.","output_parameters":{"meta":{"box":"446-6-D","session_end_time":"2024-08-07 13:46:16.146082","session_run_time_in_min":85},"performance":{"foraging_efficiency":0.511170814479638,"foraging_efficiency_with_actual_random_seed":0.5250544662309368},"task_parameters":{"AddOneTrialForNoresponse":"Yes","AdvancedBlockAuto":"now","AlignToGoCue":"yes","AutoReward":true,"AutoTrain":false,"AutoWaterType":"Natural","BaseRewardSum":"0.8","BaseWeight":"24.8","BlockBeta":"10","BlockMax":"35","BlockMin":"20","BlockMinReward":"0","Camera_dialog":{"AutoControl":"No","ClearTemporaryVideo":false,"FrameRate":"500","OpenSaveFolder":false,"StartPreview":false,"StartRecording":true,"camera_start_time":"2024-08-07 12:18:59.400471","camera_stop_time":"2024-08-07 13:49:28.342495","qt_spinbox_lineedit":"500"},"Clear":false,"DelayBeta":"0.0","DelayMax":"0.25","DelayMin":"0.25","Experimenter":"Avalon Amayal","FIPMode":"Axon","GetPositions":false,"GiveLeft":false,"GiveRight":false,"GiveWaterL":"0.038","GiveWaterL_volume":"3.00","GiveWaterR":"0.035","GiveWaterR_volume":"3.00","HarpFolder":"C:\\behavior_data\\446-6-D\\711042\\behavior_711042_2024-08-07_12-20-41\\behavior\\raw.harp","HideLegend":false,"ID":"711042","ITIBeta":"3.0","ITIIncrease":"0","ITIMax":"10.0","ITIMin":"1.0","Ignored":"7","IncludeAutoReward":"no","InitiallyInactiveN":"2","LaserCalibration_dialog":{"Capture":false,"CopyCondition":"Condition_1","CopyFromOpto":false,"CopyLaser":"Laser_1","CopyToSession":false,"Duration_1":"10","Flush_DO0":false,"Flush_DO1":false,"Flush_DO2":false,"Flush_DO3":false,"Flush_Port2":false,"Frequency_1":"40","KeepOpen":false,"LaserColor_1":"Blue","LaserPowerMeasured":"","Location_1":"Both","Open":false,"Protocol_1":"Sine","PulseDur_1":"0.002","RD_1":"1","SampleFrequency":"5000","Save":false,"qt_spinbox_lineedit":"2","showrecentlaser":"2","showspecificcalilaser":"NA","voltage":"0.1"},"LeftValue":"0.023","LeftValue_volume":"2.00","Load":false,"ManualWaterVolume":[0,0],"MartchingType":"log ratio","MaxTime":"90","MaxTrial":"1000","MetadataFolder":"C:\\behavior_data\\446-6-D\\711042\\behavior_711042_2024-08-07_12-20-41\\metadata-dir","Metadata_dialog":{"ArcAngle":"","ClearMetadata":false,"DataSummary":"","EphysProbes":"","ExperimentDescription":"Behavior training\n","Fundee":"","FundingSource":"","GoCueDecibel":"74","GrantNumber":"","IACUCProtocol":"2109","Investigators":"","LickSpoutDistance":"5000","LickSpoutReferenceArea":"","LickSpoutReferenceX":"","LickSpoutReferenceY":"","LickSpoutReferenceZ":"","LoadMeta":false,"ManipulatorX":"","ManipulatorY":"","ManipulatorZ":"","ModuleAngle":"","ProbeTarget":"","ProjectName":"","ProtocolID":"","RigMetadataFile":"rig_446-6-D_2024-08-05_11_57_22.json","RotationAngle":"","SaveMeta":false,"SelectRigMetadata":false,"StickMicroscopes":"","Stick_ArcAngle":"","Stick_ModuleAngle":"","Stick_RotationAngle":""},"MoveXN":false,"MoveXN_2":false,"MoveXP":false,"MoveXP_2":false,"MoveYN":false,"MoveYP":false,"MoveZN":false,"MoveZP":false,"Multiplier":"0.5","NewSession":false,"NextBlock":false,"OpenEphysRecordingType":"Behavior","Opto_dialog":{"":"40","ConditionP_1":"1","ConditionP_2":"1","ConditionP_3":"1","ConditionP_4":"1","ConditionP_5":"1","ConditionP_6":"1","Condition_1":"NA","Condition_2":"NA","Condition_3":"NA","Condition_4":"NA","Condition_5":"NA","Condition_6":"NA","Duration_1":"5","Duration_2":"5","Duration_3":"5","Duration_4":"5","Duration_5":"5","Duration_6":"5","FractionOfSession":"0.5","Frequency_1":"40","Frequency_2":"40","Frequency_3":"40","Frequency_4":"40","Frequency_5":"40","Frequency_6":"40","Laser1_power_1":"0 mw","Laser1_power_2":"0 mw","Laser1_power_3":"0 mw","Laser1_power_4":"0 mw","Laser1_power_5":"0 mw","Laser1_power_6":"0 mw","Laser2_power_1":"0 mw","Laser2_power_2":"0 mw","Laser2_power_3":"0 mw","Laser2_power_4":"0 mw","Laser2_power_5":"0 mw","Laser2_power_6":"0 mw","LaserColor_1":"NA","LaserColor_2":"NA","LaserColor_3":"NA","LaserColor_4":"NA","LaserColor_5":"NA","LaserColor_6":"NA","LaserEnd_1":"Trial start","LaserEnd_2":"Trial start","LaserEnd_3":"Trial start","LaserEnd_4":"Trial start","LaserEnd_5":"Trial start","LaserEnd_6":"Trial start","LaserStart_1":"Trial start","LaserStart_2":"Trial start","LaserStart_3":"Trial start","LaserStart_4":"Trial start","LaserStart_5":"Trial start","LaserStart_6":"Trial start","Laser_calibration":"Blue","LatestCalibrationDate":"NA","Location_1":"Both","Location_2":"Both","Location_3":"Both","Location_4":"Both","Location_5":"Both","Location_6":"Both","MinOptoInterval":"0","OffsetEnd_1":"0","OffsetEnd_2":"0","OffsetEnd_3":"0","OffsetEnd_4":"0","OffsetEnd_5":"0","OffsetEnd_6":"0","OffsetStart_1":"0","OffsetStart_2":"0","OffsetStart_3":"0","OffsetStart_4":"0","OffsetStart_5":"0","OffsetStart_6":"0","Probability_1":"0.25","Probability_2":"0.25","Probability_3":"0.25","Probability_4":"0.25","Probability_5":"0.25","Probability_6":"0.25","Protocol_1":"Sine","Protocol_2":"Sine","Protocol_3":"Sine","Protocol_4":"Sine","Protocol_5":"Sine","Protocol_6":"Sine","PulseDur_1":"0.002","PulseDur_2":"0.002","PulseDur_3":"0.002","PulseDur_4":"0.002","PulseDur_5":"0.002","PulseDur_6":"0.002","RD_1":"1","RD_2":"1","RD_3":"1","RD_4":"1","RD_5":"1","RD_6":"1","SampleFrequency":"5000","SessionAlternating":"on","SessionStartWith":"on","SessionWideControl":"off","laser_1_calibration_power":"","laser_1_calibration_voltage":"","laser_1_target":"","laser_2_calibration_power":"","laser_2_calibration_voltage":"","laser_2_target":""},"OptogeneticsB":"off","Ot_log_folder":"C:\\behavior_data\\446-6-D\\711042\\behavior_711042_2024-08-07_12-20-41\\behavior\\raw.harp","Other_CurrentTime":"2024-08-07 13:46:16.146082","Other_RunningTime":85,"Other_SessionStartTime":"2024-08-07 12:21:07.951292","Other_current_box":"446-6-D","Other_go_cue_decibel":"74","Other_lick_spout_distance":"5000","PhotometryB":"on","PhotometryFolder":"C:\\behavior_data\\446-6-D\\711042\\behavior_711042_2024-08-07_12-20-41\\fib","PointsInARow":"5","PositionX":"","PositionY":"","PositionZ":"","Randomness":"Exponential","ResponseTime":"1.5","RewardConsumeTime":"1.0","RewardDelay":"0.1","RewardFamily":"1","RewardPairsN":"1","RightValue":"0.022","RightValue_volume":"2.00","RunLength":"10","Save":false,"SaveFile":"C:\\behavior_data\\446-6-D\\711042\\behavior_711042_2024-08-07_12-20-41\\behavior\\711042_2024-08-07_12-20-41.json","SessionFolder":"C:\\behavior_data\\446-6-D\\711042\\behavior_711042_2024-08-07_12-20-41","Sessionlist":"","SessionlistSpin":"1","SetReference":false,"ShowNotes":"ended session at 85 min","StageStop":false,"Start":false,"StartBleaching":false,"StartEphysRecording":false,"StartExcitation":false,"StartFIP":false,"Step":"200","StepSize":"5","StopIgnores":"25","SuggestedWater":"0.493","SwitchThr":"0.5","TargetRatio":"0.85","TargetWeight":"21.08","Task":"Coupled Without Baiting","TotalWater":"1.0","TrainingFolder":"C:\\behavior_data\\446-6-D\\711042\\behavior_711042_2024-08-07_12-20-41\\behavior","UncoupledReward":"0.1,0.3,0.7","Unrewarded":"7","VideoFolder":"C:\\behavior_data\\446-6-D\\711042\\behavior_711042_2024-08-07_12-20-41\\behavior-videos","WeightAfter":"21.2","WindowSize":"100","baselinetime":"10","box":"446-6-D","commit_ID":"5428e6749f7193c4b2ea109d1d11e54d75edbfdc","current_branch":"main","dirty_files":"","drop_frames_tag":1,"drop_frames_warning_text":"Error: bottom_camera.avi has 2366948 frames, but 2663183 triggers\nError: side_camera_right.avi has 2378995 frames, but 2663183 triggers\n","fiber_mode":"Axon","fiber_photometry_end_time":"2024-08-07 13:46:32.960196","fiber_photometry_start_time":"2024-08-07 12:21:07.951292","frame_num":{"bottom_camera":2366948,"side_camera_right":2378995},"generate_data_description_success":false,"generate_rig_metadata_success":true,"generate_session_metadata_success":true,"info_performance_essential_1":"Current trial: 663\nResponded trial: 627/662 (0.95)\nReward Trial: 241/662 (0.36)\nEarned Reward: 0.482 mL\nWater in session: 0.507 mL","info_performance_essential_2":"Foraging eff: 0.51\nForaging eff (r.s.): 0.53\n\nBias: 0.59 (right)","info_performance_others":"Left choice rewarded: 97/194 (0.5)\nRight choice rewarded: 144/433 (0.33)\n\nEarly licking (EL)\n  Frac of EL trial start_goCue: 586/661 (0.89)\n  Frac of EL trial start_delay: 571/661 (0.86)\n  Frac of EL trial delay_goCue: 175/661 (0.26)\n  Left/Right early licks start_goCue: 1705/3669 (0.46)\n\nDouble dipping (DD)\n  Frac of DD trial start_goCue: 168/661 (0.25)\n  Frac of DD trial start_delay: 135/661 (0.2)\n  Frac of DD trial delay_goCue: 49/661 (0.07)\n  Frac of DD trial goCue_goCue1: 69/661 (0.1)\n  DD per finish trial start_goCue: 0.63\n  DD per finish trial goCue_goCue1: 0.13\n\n  Frac of DD trial goCue_nextStart: 83/660 (0.13)\n  DD per finish trial goCue_nextStart: 0.18\n","info_task":"Session started: 12:21\nCurrent time: 13:46\nRun time: 85 mins\n\nCurrent left block: 14/35\nCurrent right block: 14/35","open_ephys":[],"pushButton_streamlit":false,"qt_spinbox_lineedit":"10","repo_dirty_flag":false,"repo_url":"https://github.com/AllenNeuralDynamics/dynamic-foraging-task.git","saving_type_label":"normal saving","session_metadata":{},"settings":{"AutomaticUpload":true,"FIP_settings":"C:\\Users\\svc_aind_behavior\\Documents\\FIPSettings","FIP_workflow_path":"C:\\Users\\svc_aind_behavior\\Documents\\GitHub\\FIP_DAQ_Control\\src\\ThorFIP.bonsai","Teensy_COM_box1":"","Teensy_COM_box2":"","Teensy_COM_box3":"","Teensy_COM_box4":"COM7","auto_engage":true,"bonsai_config_path":"C:\\Users\\svc_aind_behavior\\Documents\\GitHub\\dynamic-foraging-task\\bonsai\\Bonsai.config","bonsai_path":"C:\\Users\\svc_aind_behavior\\Documents\\Github\\dynamic-foraging-task\\bonsai\\Bonsai.exe","bonsaiworkflow_path":"C:\\Users\\svc_aind_behavior\\Documents\\Github\\dynamic-foraging-task\\src\\workflows\\foraging.bonsai","clear_figure_after_save":true,"create_rig_metadata":true,"current_box":"446-6-D","default_openFolder":"C:\\behavior_data\\","default_saveFolder":"C:\\behavior_data\\","default_ui":"ForagingGUI.ui","go_cue_decibel_box1":60,"go_cue_decibel_box2":60,"go_cue_decibel_box3":60,"go_cue_decibel_box4":74,"lick_spout_distance_box1":5000,"lick_spout_distance_box2":5000,"lick_spout_distance_box3":5000,"lick_spout_distance_box4":5000,"manifest_flag_dir":"C:\\Users\\svc_aind_behavior\\Documents\\aind_watchdog_service\\manifest","metadata_dialog_folder":"C:\\Users\\svc_aind_behavior\\Documents\\ForagingSettings\\metadata_dialog\\","name_mapper_file":"C:\\Users\\svc_aind_behavior\\Documents\\ForagingSettings\\name_mapper.json","newscale_serial_num_box1":"","newscale_serial_num_box2":"","newscale_serial_num_box3":"","newscale_serial_num_box4":"","open_ephys_machine_ip_address":"","project_info_file":"C:\\Users\\svc_aind_behavior\\Documents\\ForagingSettings\\Project Name and Funding Source v2.csv","rig_metadata_folder":"C:\\Users\\svc_aind_behavior\\Documents\\ForagingSettings\\rig_metadata\\","save_each_trial":true,"schedule_path":"Z:\\dynamic_foraging\\DynamicForagingSchedule.csv","show_log_info_in_console":false,"temporary_video_folder":"C:\\Users\\svc_aind_behavior\\Documents\\temporaryvideo\\"},"settings_box":{"AINDLickDetector":"0","AttenuationLeft":"120","AttenuationRight":"120","Behavior":"COM3","BodyCamera":"12345678","BonsaiOsc1":"4032","BonsaiOsc2":"4033","BonsaiOsc3":"4034","BonsaiOsc4":"4035","BottomCamera":"23349436","FipObjectiveSerialNumber":"128122198","HasBodyCamera":"0","HasBottomCamera":"1","HasSideCameraLeft":"0","HasSideCameraRight":"1","HighSpeedCamera":"1","LeftLickDetector":"COM8","RightLickDetector":"COM9","SideCameraLeft":"12345678","SideCameraRight":"23347799","Soundcard":"COM4","codec":"-vcodec h264_nvenc -rc vbr -cq 23 -preset fast -b:v 50M -v 24","current_box":"446-6-D"},"trigger_length":2663183,"version":"1.4.1","warm_max_choice_ratio_bias":"0.1","warm_min_finish_ratio":"0.8","warm_min_trial":"60","warm_windowsize":"20","warmup":"off"},"water":{"water_after_session":0.493,"water_day_total":1,"water_in_session_foraging":0.507,"water_in_session_manual":0,"water_in_session_total":0.507},"weight":{"base_weight":24.8,"target_weight":21.08,"target_weight_ratio":0.85,"weight_after":21.2}},"reward_consumed_during_epoch":"507.0","reward_consumed_unit":"microliter","script":null,"session_number":null,"software":[{"name":"dynamic-foraging-task","parameters":{},"url":"https://github.com/AllenNeuralDynamics/dynamic-foraging-task.git","version":"behavior branch:main   commit ID:5428e6749f7193c4b2ea109d1d11e54d75edbfdc    version:1.4.1; metadata branch: main   commit ID:5428e6749f7193c4b2ea109d1d11e54d75edbfdc   version:1.4.1"}],"speaker_config":{"name":"Stimulus Speaker","volume":"74","volume_unit":"decibels"},"stimulus_device_names":[],"stimulus_end_time":"2024-08-07T13:46:16.146082-07:00","stimulus_modalities":["Auditory"],"stimulus_name":"auditory go cue","stimulus_parameters":[{"amplitude_modulation_frequency":7500,"bandpass_filter_type":null,"bandpass_high_frequency":null,"bandpass_low_frequency":null,"bandpass_order":null,"frequency_unit":"hertz","notes":null,"sample_frequency":"96000","sitmulus_name":"auditory go cue","stimulus_type":"Auditory Stimulation"}],"stimulus_start_time":"2024-08-07T12:21:07.951292-07:00","trials_finished":627,"trials_rewarded":241,"trials_total":663}],"subject_id":"711042","weight_unit":"gram"},"subject":{"alleles":[],"background_strain":null,"breeding_info":{"breeding_group":"Dbh-Cre-KI(ND)","maternal_genotype":"wt/wt","maternal_id":"701598","paternal_genotype":"Dbh-Cre-KI/wt","paternal_id":"699390"},"date_of_birth":"2023-11-06","describedBy":"https://raw.githubusercontent.com/AllenNeuralDynamics/aind-data-schema/main/src/aind_data_schema/core/subject.py","genotype":"Dbh-Cre-KI/wt","housing":{"cage_id":"8260791","cohoused_subjects":[],"home_cage_enrichment":[],"light_cycle":null,"room_id":"221"},"notes":null,"restrictions":null,"rrid":null,"schema_version":"0.5.5","sex":"Female","source":{"abbreviation":"AI","name":"Allen Institute","registry":{"abbreviation":"ROR","name":"Research Organization Registry"},"registry_identifier":"03cpe7c52"},"species":{"abbreviation":null,"name":"Mus musculus","registry":{"abbreviation":"NCBI","name":"National Center for Biotechnology Information"},"registry_identifier":"10090"},"subject_id":"711042","wellness_reports":[]}}

Now create the run.py that solves the issue and return the contents of the file.
"""

def get_github_issues(repo_owner: str = "AllenNeuralDynamics", 
                     repo_name: str = "aind-scicomp-nautilex") -> List[Dict]:
    """
    Fetch GitHub issues for the specified repository using a personal access token.
    
    Args:
        repo_owner: The owner of the repository
        repo_name: The name of the repository
        
    Returns:
        List of dictionaries containing issue information
    """
    token = os.getenv("GITHUB_ACCESS_TOKEN")
    if not token:
        raise ValueError("GitHub access token not found in environment variables")
        
    headers = {
        "Authorization": f"token {token}",
        "Accept": "application/vnd.github.v3+json"
    }
    
    url = f"https://api.github.com/repos/{repo_owner}/{repo_name}/issues"
    
    response = requests.get(url, headers=headers)
    if response.status_code != 200:
        raise Exception(f"Failed to fetch issues: {response.status_code}, {response.text}")
        
    return response.json()


def analyze_issues_with_bedrock(issues: List[Dict], system_prompt: str) -> List[str]:
    """
    Analyze GitHub issues using Amazon Bedrock Claude model.
    
    Args:
        issues: List of GitHub issue dictionaries
        system_prompt: System prompt to send to Claude
        
    Returns:
        List of Claude's responses as strings
    """
    try:
        import boto3
    except ImportError:
        raise ImportError("boto3 is required to use Bedrock. Please install it.")
        
    bedrock = boto3.client('bedrock-runtime')
    responses = []
    
    for issue in issues:
        # Combine issue content into a single string
        issue_content = f"Title: {issue['title']}\nBody: {issue['body']}"
        
        # Prepare the prompt
        prompt = f"{system_prompt}\n\nIssue Content:\n{issue_content}"
        
        # Call Bedrock Claude
        body = {
            "prompt": f"\n\nHuman: {prompt}\n\nAssistant:",
            "max_tokens_to_sample": 2048,
            "temperature": 0.5,
            "anthropic_version": "bedrock-2023-05-31"
        }
        
        response = bedrock.invoke_model(
            modelId="anthropic.claude-v2",
            body=json.dumps(body)
        )
        
        response_body = json.loads(response['body'].read())
        run_py_str = response_body['completion']
        responses.append(run_py_str)
        
    return responses

if __name__ == "__main__":
    try:
        issues = get_github_issues()
        for issue in issues:
            print(f"Issue #{issue['number']}: {issue['title']}")
            print(f"State: {issue['state']}")
            print(f"URL: {issue['html_url']}")
            print("-" * 50)

        responses = analyze_issues_with_bedrock(issues, system_prompt=system_prompt)
        for i, response in enumerate(responses):
            print(f"\nAnalysis for issue #{i+1}:")
            print(response)
            print("-" * 50)
    
    except Exception as e:
        print(f"Error: {str(e)}")
